<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.renkaen.cat_hospital.mapper.RecordsMapper">
    <resultMap id="RecordJoinCat" type="com.renkaen.cat_hospital.bean.DTO.RecordsJoinCatsDTO" autoMapping="true">
        <association property="catsDTO" resultMap="catsDTO" autoMapping="true" />
        <collection property="billList" column="record_id=record_id" select="selectBillByRecordId"/>
        <collection property="treatments" column="record_id=record_id" select="selectTreatmentByRecordId"/>
    </resultMap>
    <resultMap id="catsDTO" type="com.renkaen.cat_hospital.bean.DTO.CatsDTO" autoMapping="true">
        <collection property="vaccine" select="selectVaccineByCatId" column="cat_id=cat_id"/>
        <collection property="vermifuge" select="selectVermifugeByCatId" column="cat_id=cat_id" />
    </resultMap>
    <!--==================================================================-->
    <select id="selectVaccineByCatId" resultType="com.renkaen.cat_hospital.bean.DO.Vaccine">
        select *
        from vaccine_table
        where cat_id = #{cat_id}
    </select>
    <select id="selectVermifugeByCatId" resultType="com.renkaen.cat_hospital.bean.DO.Vermifuge">
        select *
        from vermifuge_table
        where cat_id = #{cat_id}
    </select>
    <select id="selectBillByRecordId" resultType="com.renkaen.cat_hospital.bean.DO.Bill">
        select *
        from bill_table
        where record_id = #{record_id}
    </select>
    <select id="selectTreatmentByRecordId" resultType="com.renkaen.cat_hospital.bean.DO.Treatment">
        select *
        from treatment_table
        where record_id = #{record_id}
    </select>
    <!--==================================================================-->
    <!--通过bill查询record+cat-->
    <select id="selectRecordJoinCat" resultMap="RecordJoinCat">
        select *
        from (select * from records_table where bill_status=#{billStatus}) records
            left join cats_table cats on records.cat_id = cats.cat_id
    </select>
    <!--助理的待办事项：bill查询recard+cat-->
    <select id="selectRecordJoinCatByAssistant" resultMap="RecordJoinCat">
        select *
        from  records_table  record left join cats_table cats on record.cat_id = cats.cat_id
        where (record.bill_statue =1 or record.bill_statue = 0) and record.reserve = 1;
    </select>
    <!--医生的待办事项：bill查询recard+cat-->
    <select id="selectRecordJoinCatByStaffId" resultMap="RecordJoinCat">
        select *
        from  records_table  record left join cats_table cats on record.cat_id = cats.cat_id
        where record.staff_id = #{staffId} and record.reserve = 0;
    </select>
    <!--两个时间点之间某个staffId的所有records-->
    <select id="selectRecordByTimeAndStaffId" resultType="com.renkaen.cat_hospital.bean.DO.Records">
        select *
        from records_table
        where `key` &gt;= #{timeStart} and `key` &lt;= #{timeEnd} and staff_id = #{staffId}
    </select>
    <!--超过某个时间点的所有预约记录-->
    <select id="selectRecordsByTime" resultMap="RecordJoinCat">
        select *
        from (select * from records_table where `key` &gt;= #{timeStart}) records
                 left join cats_table cats on records.cat_id = cats.cat_id
    </select>
    <!--根据权限id获取权限信息-->
    <select id="selectUserById" resultType="com.renkaen.cat_hospital.bean.DO.Records">
        select *
        from records_table
        where cat_id = #{id};
    </select>

    <!--新增病历记录-->
    <insert id="insertRecords">
        insert into records_table (id, cat_id, `key`, staff_id, weight, treatments,diagnosis, reserve,bill_statue )
        values (default, #{catId}, #{key}, #{staffId}, #{weight}, #{treatments},#{diagnosis},#{reserve},#{billStatus})
    </insert>

    <!-- 根据id更新病历记录 -->
    <update id="updateRecordsById" parameterType="com.renkaen.cat_hospital.bean.DO.Records">
        update records_table
        set cat_id = ifnull( #{records.catId},cat_id ),
            staff_id = ifnull( #{records.staffId} , staff_id ),
            `key` = ifnull( #{records.keyTime} , `key` ),
            weight = ifnull( #{records.weight} , weight ),
            treatments = ifnull( #{records.treatments} , treatments ),
            diagnosis = ifnull( #{records.diagnosis} , diagnosis ),
            reserve = ifnull( #{records.reserve} , reserve ),
            bill_statue = ifnull( #{records.bill} , bill_statue )
        where cat_id = #{id}
    </update>

    <delete id="deleteRecordsById">
        delete
        from records_table
        where cat_id = #{id}
    </delete>


</mapper>